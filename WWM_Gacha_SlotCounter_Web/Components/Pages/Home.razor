@page "/"
@using WWM_Gacha_SlotCounter_Web.Services
@inject GachaService GachaService
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>WWM Gacha Slot Counter</PageTitle>

<h1>Where Gacha Meets - Slot Counter</h1>
<p>Made by your beloved Will - MaiMaiYeuEm</p>

<div style="margin: 20px 0;">
    <h2>Total Pulls: @GachaService.GetTotalPulls()</h2>
</div>

<div style="margin-bottom: 20px;">
    <button @onclick="@(() => activeTab = "click")" style="padding: 10px 20px; margin-right: 10px; background: @(activeTab == "click" ? "#3498DB" : "#ccc"); color: white; border: none; border-radius: 5px;">
        Click to Input
    </button>
    <button @onclick="@(() => activeTab = "data")" style="padding: 10px 20px; background: @(activeTab == "data" ? "#3498DB" : "#ccc"); color: white; border: none; border-radius: 5px;">
        Data Input
    </button>
</div>

@if (activeTab == "click")
{
    <div>
        <h3>Click to Input</h3>
        @for (int i = 1; i <= 5; i++)
        {
            int slotIndex = i;
            string slotName = $"Slot{slotIndex}";
            string? selected = GachaService.GetSlotSelection(slotName);
            int counter = GachaService.GetSlotCounter(slotName);

            <div style="margin: 10px 0;">
                <strong>Slot @slotIndex:</strong>
                <button @onclick="@(() => SelectColor(slotName, "White"))" style="margin: 0 5px; padding: 8px; background: @(selected == "White" ? "#ddd" : "white"); border: 2px solid @(selected == "White" ? "black" : "#999");">âšª White</button>
                <button @onclick="@(() => SelectColor(slotName, "Purple"))" style="margin: 0 5px; padding: 8px; background: @(selected == "Purple" ? "#ddd" : "white"); border: 2px solid @(selected == "Purple" ? "black" : "#999");">ğŸŸ£ Purple</button>
                <button @onclick="@(() => SelectColor(slotName, "Gold"))" style="margin: 0 5px; padding: 8px; background: @(selected == "Gold" ? "#ddd" : "white"); border: 2px solid @(selected == "Gold" ? "black" : "#999");">ğŸŸ¡ Gold</button>
                <span style="margin-left: 10px; color: @(selected != null ? "green" : "#999");">@(selected ?? "Select")</span>
                <span style="margin-left: 10px;">Count: @counter</span>
            </div>
        }
        
        <div style="margin: 20px 0;">
            <button @onclick="HandleConfirm" style="padding: 15px 30px; margin-right: 10px; background: #3498DB; color: white; border: none; border-radius: 8px; font-size: 16px;">âœ… Confirm</button>
            <button @onclick="HandleBack" style="padding: 15px 30px; margin-right: 10px; background: #E67E22; color: white; border: none; border-radius: 8px; font-size: 16px;">â¬…ï¸ Back</button>
            <button @onclick="HandleReset" style="padding: 15px 30px; background: #E74C3C; color: white; border: none; border-radius: 8px; font-size: 16px;">ğŸ”„ Reset All</button>
        </div>

        <h4>ğŸ“ Gacha Log (Click to Input)</h4>
        <div style="background: #f9f9f9; padding: 10px; max-height: 200px; overflow-y: auto;">
            @{
                var clickRecords = GachaService.GetPullHistory().Where(r => r.InputSource == "Click").ToList();
            }
            @if (clickRecords.Count == 0)
            {
                <p style="color: #999;">No pulls recorded yet</p>
            }
            else
            {
                @foreach (var record in clickRecords)
                {
                    string colorsInfo = string.Join(", ", record.SlotColors.OrderBy(x => x.Key).Select(x => $"{x.Key}: {x.Value}"));
                    <div style="margin-bottom: 8px;">
                        Pull #@record.PullNumber (@record.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")) - @colorsInfo
                    </div>
                }
            }
        </div>
    </div>
}

@if (activeTab == "data")
{
    <div>
        <h3>Data Input</h3>
        @for (int i = 1; i <= 5; i++)
        {
            int slotIndex = i;
            string slotName = $"Slot{slotIndex}";
            string? selected = dataSlotSelections[slotName];

            <div style="margin: 10px 0;">
                <strong>Slot @slotIndex:</strong>
                <button @onclick="@(() => SelectDataColor(slotName, "White"))" style="margin: 0 5px; padding: 8px; background: @(selected == "White" ? "#ddd" : "white"); border: 2px solid @(selected == "White" ? "black" : "#999");">âšª White</button>
                <button @onclick="@(() => SelectDataColor(slotName, "Purple"))" style="margin: 0 5px; padding: 8px; background: @(selected == "Purple" ? "#ddd" : "white"); border: 2px solid @(selected == "Purple" ? "black" : "#999");">ğŸŸ£ Purple</button>
                <button @onclick="@(() => SelectDataColor(slotName, "Gold"))" style="margin: 0 5px; padding: 8px; background: @(selected == "Gold" ? "#ddd" : "white"); border: 2px solid @(selected == "Gold" ? "black" : "#999");">ğŸŸ¡ Gold</button>
                <span style="margin-left: 10px; color: @(selected != null ? "green" : "#999");">@(selected ?? "Select")</span>
                <input type="number" @bind="dataSlotCounts[slotName]" min="0" placeholder="Count" style="margin-left: 10px; padding: 8px; width: 80px; border: 2px solid #3498DB; border-radius: 5px; text-align: center;" />
            </div>
        }
        
        <div style="margin: 20px 0;">
            <button @onclick="HandleDataConfirm" style="padding: 15px 30px; margin-right: 10px; background: #3498DB; color: white; border: none; border-radius: 8px; font-size: 16px;">âœ… Confirm</button>
            <button @onclick="HandleDataBack" style="padding: 15px 30px; margin-right: 10px; background: #E67E22; color: white; border: none; border-radius: 8px; font-size: 16px;">â¬…ï¸ Back</button>
            <button @onclick="HandleReset" style="padding: 15px 30px; background: #E74C3C; color: white; border: none; border-radius: 8px; font-size: 16px;">ğŸ”„ Reset All</button>
        </div>

        <h4>ğŸ“ Gacha Log (Data Input)</h4>
        <div style="background: #f9f9f9; padding: 10px; max-height: 200px; overflow-y: auto;">
            @{
                var dataRecords = GachaService.GetPullHistory().Where(r => r.InputSource == "Data").ToList();
            }
            @if (dataRecords.Count == 0)
            {
                <p style="color: #999;">No pulls recorded yet</p>
            }
            else
            {
                @foreach (var record in dataRecords)
                {
                    string colorsInfo = string.Join(", ", record.SlotColors.OrderBy(x => x.Key).Select(x => $"{x.Key}: {x.Value}"));
                    string countsInfo = string.Join(", ", record.SlotCounters.OrderBy(x => x.Key).Select(x => $"{x.Key}: {x.Value}"));
                    <div style="margin-bottom: 8px;">
                        Pull #@record.PullNumber (@record.Timestamp.ToString("yyyy-MM-dd HH:mm:ss"))<br/>
                        Colors: @colorsInfo<br/>
                        Counts: @countsInfo
                    </div>
                }
            }
        </div>
    </div>
}

<div style="margin-top: 30px;">
    <h3>ğŸ“Š Statistics</h3>
    <p><strong>Session Pulls:</strong> @GachaService.GetSessionPulls()</p>
    <p><strong>Average per session:</strong> @GachaService.GetAveragePulls().ToString("F1")</p>
</div>

@code {
    private string activeTab = "click";
    private Dictionary<string, string?> dataSlotSelections = new();
    private Dictionary<string, int> dataSlotCounts = new();

    protected override void OnInitialized()
    {
        InitializeDataInputs();
    }

    private void InitializeDataInputs()
    {
        for (int i = 1; i <= 5; i++)
        {
            string slotName = $"Slot{i}";
            dataSlotSelections[slotName] = null;
            dataSlotCounts[slotName] = 0;
        }
    }

    private void SelectColor(string slotName, string colorName)
    {
        GachaService.SelectColor(slotName, colorName);
        StateHasChanged();
    }

    private void SelectDataColor(string slotName, string colorName)
    {
        dataSlotSelections[slotName] = colorName;
        StateHasChanged();
    }

    private async Task HandleConfirm()
    {
        try
        {
            GachaService.ConfirmPull("Click");
            StateHasChanged();
            await JS.InvokeVoidAsync("alert", "âœ… Pull confirmed!");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    private async Task HandleDataConfirm()
    {
        try
        {
            GachaService.ConfirmDataPull(dataSlotSelections, dataSlotCounts);
            InitializeDataInputs();
            StateHasChanged();
            await JS.InvokeVoidAsync("alert", "âœ… Data pull confirmed!");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    private void HandleBack()
    {
        GachaService.BackClick();
        StateHasChanged();
    }

    private void HandleDataBack()
    {
        InitializeDataInputs();
        StateHasChanged();
    }

    private async Task HandleReset()
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to reset all pulls and counters?");
        if (confirmed)
        {
            GachaService.ResetAll();
            InitializeDataInputs();
            StateHasChanged();
            await JS.InvokeVoidAsync("alert", "âœ… All data reset!");
        }
    }
}

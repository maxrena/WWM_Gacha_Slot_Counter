@page "/"
@using WWM_Gacha_SlotCounter_Web.Services
@inject GachaService GachaService
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>WWM Gacha Slot Counter</PageTitle>

<div style="max-width: 900px; margin: 0 auto; padding: 15px;">
    <div style="text-align: center; margin-bottom: 15px;">
        <h2 style="margin: 0; color: #2C3E50;">ğŸ° WWM Gacha Slot Counter</h2>
        <p style="margin: 5px 0; color: #7F8C8D; font-size: 14px;">Made by Will - MaiMaiYeuEm</p>
        <h3 style="margin: 10px 0; color: #E74C3C;">Total Pulls: @GachaService.GetTotalPulls()</h3>
    </div>

    <div style="display: flex; gap: 10px; margin-bottom: 15px; justify-content: center;">
        <button @onclick="@(() => activeTab = "click")" style="padding: 10px 25px; background: @(activeTab == "click" ? "#3498DB" : "#95a5a6"); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: background 0.3s;">
            ğŸ‘† Click to Input
        </button>
        <button @onclick="@(() => activeTab = "data")" style="padding: 10px 25px; background: @(activeTab == "data" ? "#3498DB" : "#95a5a6"); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: background 0.3s;">
            ğŸ“ Data Input
        </button>
    </div>

@if (activeTab == "click")
{
    <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        @for (int i = 1; i <= 5; i++)
        {
            int slotIndex = i;
            string slotName = $"Slot{slotIndex}";
            string? selected = GachaService.GetSlotSelection(slotName);
            int counter = GachaService.GetSlotCounter(slotName);

            <div style="display: flex; align-items: center; margin-bottom: 8px; gap: 8px; flex-wrap: wrap;">
                <strong style="min-width: 60px;">Slot @slotIndex:</strong>
                <button @onclick="@(() => SelectColor(slotName, "White"))" style="padding: 6px 12px; background: @(selected == "White" ? "#ecf0f1" : "white"); border: 2px solid @(selected == "White" ? "#2c3e50" : "#bdc3c7"); border-radius: 4px; cursor: pointer; font-size: 14px;">âšª White</button>
                <button @onclick="@(() => SelectColor(slotName, "Purple"))" style="padding: 6px 12px; background: @(selected == "Purple" ? "#ecf0f1" : "white"); border: 2px solid @(selected == "Purple" ? "#2c3e50" : "#bdc3c7"); border-radius: 4px; cursor: pointer; font-size: 14px;">ğŸŸ£ Purple</button>
                <button @onclick="@(() => SelectColor(slotName, "Gold"))" style="padding: 6px 12px; background: @(selected == "Gold" ? "#ecf0f1" : "white"); border: 2px solid @(selected == "Gold" ? "#2c3e50" : "#bdc3c7"); border-radius: 4px; cursor: pointer; font-size: 14px;">ğŸŸ¡ Gold</button>
                <span style="color: @(selected != null ? "#27ae60" : "#95a5a6"); font-weight: bold; font-size: 14px;">@(selected ?? "Not Selected")</span>
                <span style="background: #ecf0f1; padding: 4px 10px; border-radius: 4px; font-size: 14px;">Count: @counter</span>
            </div>
        }
        
        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
            <button @onclick="HandleConfirm" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">âœ… Confirm</button>
            <button @onclick="HandleBack" style="padding: 10px 20px; background: #e67e22; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">â¬…ï¸ Back</button>
            <button @onclick="HandleReset" style="padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">ğŸ”„ Reset All</button>
        </div>

        <h4 style="margin: 15px 0 10px 0; color: #2c3e50;">ğŸ“ Gacha Log</h4>
        <div style="background: #ecf0f1; padding: 10px; max-height: 180px; overflow-y: auto; border-radius: 6px; font-size: 13px;">
            @{
                var clickRecords = GachaService.GetPullHistory().Where(r => r.InputSource == "Click").ToList();
            }
            @if (clickRecords.Count == 0)
            {
                <p style="color: #999;">No pulls recorded yet</p>
            }
            else
            {
                @foreach (var record in clickRecords)
                {
                    string colorsInfo = string.Join(", ", record.SlotColors.OrderBy(x => x.Key).Select(x => $"{x.Key.Replace("Slot", "Slot ")}: {x.Value}"));
                    <div style="margin-bottom: 8px;">
                        Pull #@record.PullNumber (@record.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")) - @colorsInfo
                    </div>
                }
            }
        </div>
    </div>
}

@if (activeTab == "data")
{
    <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        @for (int i = 1; i <= 5; i++)
        {
            int slotIndex = i;
            string slotName = $"Slot{slotIndex}";
            string? selected = dataSlotSelections[slotName];

            <div style="display: flex; align-items: center; margin-bottom: 8px; gap: 8px; flex-wrap: wrap;">
                <strong style="min-width: 60px;">Slot @slotIndex:</strong>
                <button @onclick="@(() => SelectDataColor(slotName, "White"))" style="padding: 6px 12px; background: @(selected == "White" ? "#ecf0f1" : "white"); border: 2px solid @(selected == "White" ? "#2c3e50" : "#bdc3c7"); border-radius: 4px; cursor: pointer; font-size: 14px;">âšª White</button>
                <button @onclick="@(() => SelectDataColor(slotName, "Purple"))" style="padding: 6px 12px; background: @(selected == "Purple" ? "#ecf0f1" : "white"); border: 2px solid @(selected == "Purple" ? "#2c3e50" : "#bdc3c7"); border-radius: 4px; cursor: pointer; font-size: 14px;">ğŸŸ£ Purple</button>
                <button @onclick="@(() => SelectDataColor(slotName, "Gold"))" style="padding: 6px 12px; background: @(selected == "Gold" ? "#ecf0f1" : "white"); border: 2px solid @(selected == "Gold" ? "#2c3e50" : "#bdc3c7"); border-radius: 4px; cursor: pointer; font-size: 14px;">ğŸŸ¡ Gold</button>
                <span style="color: @(selected != null ? "#27ae60" : "#95a5a6"); font-weight: bold; font-size: 14px;">@(selected ?? "Not Selected")</span>
                <input type="number" @bind="dataSlotCounts[slotName]" min="0" placeholder="Count" style="padding: 6px; width: 80px; border: 2px solid #3498db; border-radius: 4px; text-align: center; font-size: 14px;" />
            </div>
        }
        
        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
            <button @onclick="HandleDataConfirm" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">âœ… Confirm</button>
            <button @onclick="HandleDataBack" style="padding: 10px 20px; background: #e67e22; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">â¬…ï¸ Back</button>
            <button @onclick="HandleReset" style="padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">ğŸ”„ Reset All</button>
        </div>

        <h4 style="margin: 15px 0 10px 0; color: #2c3e50;">ğŸ“ Gacha Log</h4>
        <div style="background: #ecf0f1; padding: 10px; max-height: 180px; overflow-y: auto; border-radius: 6px; font-size: 13px;">
            @{
                var dataRecords = GachaService.GetPullHistory().Where(r => r.InputSource == "Data").ToList();
            }
            @if (dataRecords.Count == 0)
            {
                <p style="color: #999;">No pulls recorded yet</p>
            }
            else
            {
                @foreach (var record in dataRecords)
                {
                    string colorsInfo = string.Join(", ", record.SlotColors.OrderBy(x => x.Key).Select(x => $"{x.Key.Replace("Slot", "Slot ")}: {x.Value}"));
                    string countsInfo = string.Join(", ", record.SlotCounters.OrderBy(x => x.Key).Select(x => $"{x.Key.Replace("Slot", "Slot ")}: {x.Value}"));
                    <div style="margin-bottom: 8px;">
                        Pull #@record.PullNumber (@record.Timestamp.ToString("yyyy-MM-dd HH:mm:ss"))<br/>
                        Colors: @colorsInfo<br/>
                        Counts: @countsInfo
                    </div>
                }
            }
        </div>
    </div>
}

<div style="background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 15px;">
    <h4 style="margin: 0 0 8px 0; color: #2c3e50;">ğŸ“Š Statistics</h4>
    <div style="font-size: 14px; color: #34495e;">
        <p style="margin: 5px 0;"><strong>Session Pulls:</strong> @GachaService.GetSessionPulls()</p>
        <p style="margin: 5px 0;"><strong>Average per session:</strong> @GachaService.GetAveragePulls().ToString("F1")</p>
    </div>
</div>
</div>

@code {
    private string activeTab = "click";
    private Dictionary<string, string?> dataSlotSelections = new();
    private Dictionary<string, int> dataSlotCounts = new();

    protected override void OnInitialized()
    {
        InitializeDataInputs();
    }

    private void InitializeDataInputs()
    {
        for (int i = 1; i <= 5; i++)
        {
            string slotName = $"Slot{i}";
            dataSlotSelections[slotName] = null;
            dataSlotCounts[slotName] = 0;
        }
    }

    private void SelectColor(string slotName, string colorName)
    {
        GachaService.SelectColor(slotName, colorName);
        StateHasChanged();
    }

    private void SelectDataColor(string slotName, string colorName)
    {
        dataSlotSelections[slotName] = colorName;
        StateHasChanged();
    }

    private async Task HandleConfirm()
    {
        try
        {
            GachaService.ConfirmPull("Click");
            StateHasChanged();
            await JS.InvokeVoidAsync("alert", "âœ… Pull confirmed!");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    private async Task HandleDataConfirm()
    {
        try
        {
            GachaService.ConfirmDataPull(dataSlotSelections, dataSlotCounts);
            InitializeDataInputs();
            StateHasChanged();
            await JS.InvokeVoidAsync("alert", "âœ… Data pull confirmed!");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    private void HandleBack()
    {
        GachaService.BackClick();
        StateHasChanged();
    }

    private void HandleDataBack()
    {
        InitializeDataInputs();
        StateHasChanged();
    }

    private async Task HandleReset()
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to reset all pulls and counters?");
        if (confirmed)
        {
            GachaService.ResetAll();
            InitializeDataInputs();
            StateHasChanged();
            await JS.InvokeVoidAsync("alert", "âœ… All data reset!");
        }
    }
}
